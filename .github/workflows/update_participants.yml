name: Update Participants

on:
  schedule:
    - cron: '0 5-21/2 * * *' # every 2 hours, 05:00–21:00 UTC
  workflow_dispatch:

permissions:
  contents: write

env:
  GITHUB_REPO: ${{ github.repository }}

jobs:
  scrape:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - championship_id: '537'
            championship_name: 'HTRS Touring [9]'
            scrape_url: 'https://yoklmnracing.ru/championships/537'
          - championship_id: '538'
            championship_name: 'HTRS Mazda MX-5 Cup [2]'
            scrape_url: 'https://yoklmnracing.ru/championships/538'
          - championship_id: '543'
            championship_name: 'HTRS Corsa Endurance Cup [1]'
            scrape_url: 'https://yoklmnracing.ru/championships/543'
    steps:
      - name: Download Scraper Binary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download scraper-latest --repo "$GITHUB_REPO" --pattern "scraper-linux-amd64" --clobber
          chmod +x scraper-linux-amd64

      - name: Run Scraper
        run: |
          CHAMPIONSHIP_ID='${{ matrix.championship_id }}'
          SCRAPE_URL='${{ matrix.scrape_url }}'
          ./scraper-linux-amd64 --url="$SCRAPE_URL" --output="participants-${CHAMPIONSHIP_ID}.csv" --with-reverse-name
          # Hack: Rename car model (LADA С GT -> LADA 2118 Concept C GT)
          if [ "$CHAMPIONSHIP_ID" = "537" ]; then
            sed -i 's/LADA С GT/LADA 2118 Concept C GT/g' "participants-${CHAMPIONSHIP_ID}.csv"
            sed -i 's/LADA С GT/LADA 2118 Concept C GT/g' "participants-${CHAMPIONSHIP_ID}-name-reversed.csv"
          fi

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CHAMPIONSHIP_ID='${{ matrix.championship_id }}'
          TAG="championship-${CHAMPIONSHIP_ID}"
          TEMP_TAG="${TAG}-pending"
          FILE="participants-${CHAMPIONSHIP_ID}.csv"
          FILE_REVERSED="participants-${CHAMPIONSHIP_ID}-name-reversed.csv"
          README_LINK="https://github.com/$GITHUB_REPO/blob/main/scraper/README.md"

          CHAMPIONSHIP_NAME='${{ matrix.championship_name }}'

          NOTES="${CHAMPIONSHIP_NAME}: Updated: $(date -u +'%Y-%m-%d %H:%M:%S') UTC.
          See scraper [README]($README_LINK) for details."

          # Verify output files exist before touching any release
          [ -f "$FILE" ] && [ -f "$FILE_REVERSED" ] || { echo "ERROR: output files missing"; exit 1; }

          # Step 1: create new release under temp tag (old release untouched if this fails)
          gh release delete "$TEMP_TAG" --repo "$GITHUB_REPO" --cleanup-tag --yes 2>/dev/null || true
          gh release create "$TEMP_TAG" "$FILE" "$FILE_REVERSED" --repo "$GITHUB_REPO" \
            --title "${CHAMPIONSHIP_NAME}" \
            --notes "$NOTES"

          # Step 2: new release is ready — now atomically swap tags
          gh release delete "$TAG" --repo "$GITHUB_REPO" --cleanup-tag --yes 2>/dev/null || true
          gh release edit "$TEMP_TAG" --repo "$GITHUB_REPO" --tag "$TAG" --title "${CHAMPIONSHIP_NAME}"
